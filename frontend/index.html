<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Commerce Kafka Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:    #6366f1;
      --primary-dk: #4f46e5;
      --success:    #22c55e;
      --warning:    #f59e0b;
      --danger:     #ef4444;
      --info:       #3b82f6;
      --bg:         #f1f5f9;
      --card:       #ffffff;
      --border:     #e2e8f0;
      --text:       #1e293b;
      --muted:      #64748b;
      --sidebar-w:  340px;
    }

    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* â”€â”€ NAV â”€â”€ */
    nav {
      background: var(--primary);
      color: #fff;
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      position: sticky; top: 0; z-index: 100;
    }
    nav .brand { font-size: 1.1rem; font-weight: 700; letter-spacing: .5px; flex: 1; }
    .service-pills { display: flex; gap: 8px; }
    .pill {
      display: flex; align-items: center; gap: 5px;
      background: rgba(255,255,255,.15);
      border-radius: 20px; padding: 3px 10px; font-size: .75rem;
      cursor: default;
    }
    .pill .dot { width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; }
    .pill.up   .dot { background: var(--success); box-shadow: 0 0 6px var(--success); }
    .pill.down .dot { background: var(--danger); }

    /* â”€â”€ LAYOUT â”€â”€ */
    .layout { display: flex; height: calc(100vh - 56px); overflow: hidden; }
    main   { flex: 1; overflow-y: auto; padding: 24px; }
    aside  { width: var(--sidebar-w); background: var(--card); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }

    /* â”€â”€ TABS â”€â”€ */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--card); border-radius: 10px; padding: 6px; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
    .tab-btn {
      flex: 1; padding: 10px 0; border: none; background: transparent;
      border-radius: 7px; cursor: pointer; font-size: .9rem; font-weight: 500;
      color: var(--muted); transition: all .2s;
    }
    .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(99,102,241,.4); }
    .tab-btn:hover:not(.active) { background: var(--bg); color: var(--text); }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ CARDS â”€â”€ */
    .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 1px 6px rgba(0,0,0,.06); margin-bottom: 20px; }
    .card h2 { font-size: 1rem; font-weight: 600; margin-bottom: 16px; color: var(--text); }

    /* â”€â”€ FORM â”€â”€ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group.full { grid-column: 1 / -1; }
    label { font-size: .8rem; font-weight: 500; color: var(--muted); }
    input, select {
      padding: 9px 12px; border: 1.5px solid var(--border); border-radius: 8px;
      font-size: .9rem; background: var(--bg); color: var(--text);
      transition: border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,.15); }

    .btn {
      padding: 10px 22px; border: none; border-radius: 8px; font-size: .9rem;
      font-weight: 600; cursor: pointer; transition: all .2s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dk); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99,102,241,.4); }
    .btn-primary:active { transform: translateY(0); }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1.5px solid var(--border); }
    .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
    .btn-sm { padding: 6px 14px; font-size: .8rem; }
    .btn:disabled { opacity: .6; cursor: not-allowed; transform: none !important; }

    /* â”€â”€ TABLES â”€â”€ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .85rem; }
    th { text-align: left; padding: 10px 12px; font-size: .75rem; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--muted); border-bottom: 2px solid var(--border); white-space: nowrap; }
    td { padding: 11px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f8faff; }
    .empty-row td { text-align: center; color: var(--muted); padding: 32px; }

    /* â”€â”€ BADGES â”€â”€ */
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 20px; font-size: .75rem; font-weight: 600;
    }
    .badge-success  { background: #dcfce7; color: #166534; }
    .badge-warning  { background: #fef9c3; color: #854d0e; }
    .badge-danger   { background: #fee2e2; color: #991b1b; }
    .badge-info     { background: #dbeafe; color: #1e40af; }
    .badge-gray     { background: #f1f5f9; color: var(--muted); }

    /* â”€â”€ STAT CARDS â”€â”€ */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .stat-card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 1px 6px rgba(0,0,0,.06); text-align: center; }
    .stat-card .num { font-size: 2rem; font-weight: 700; color: var(--primary); }
    .stat-card .lbl { font-size: .75rem; color: var(--muted); margin-top: 2px; }

    /* â”€â”€ STOCK BAR â”€â”€ */
    .stock-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
    .stock-bar-fill { height: 100%; background: var(--success); border-radius: 3px; transition: width .4s; }
    .stock-bar-fill.low  { background: var(--warning); }
    .stock-bar-fill.empty { background: var(--danger); }

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-header h3 { font-size: .9rem; font-weight: 600; }
    .refresh-indicator { display: flex; align-items: center; gap: 6px; font-size: .75rem; color: var(--muted); }
    .pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }

    .activity-feed { flex: 1; overflow-y: auto; padding: 12px; }
    .activity-item {
      display: flex; gap: 10px; padding: 10px; margin-bottom: 6px;
      border-radius: 8px; background: var(--bg); font-size: .8rem;
      animation: slideIn .3s ease;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
    .activity-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .activity-icon.order     { background: #ede9fe; }
    .activity-icon.payment   { background: #dcfce7; }
    .activity-icon.inventory { background: #fef3c7; }
    .activity-icon.fail      { background: #fee2e2; }
    .activity-body .title  { font-weight: 600; color: var(--text); }
    .activity-body .detail { color: var(--muted); margin-top: 1px; }
    .activity-body .time   { color: var(--muted); font-size: .72rem; margin-top: 2px; }

    /* â”€â”€ TOAST â”€â”€ */
    #toast-container { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
    .toast {
      min-width: 260px; padding: 12px 16px; border-radius: 10px; font-size: .85rem;
      font-weight: 500; box-shadow: 0 4px 20px rgba(0,0,0,.15);
      display: flex; align-items: center; gap: 10px;
      animation: toastIn .3s ease; color: #fff;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .toast.success { background: var(--success); }
    .toast.error   { background: var(--danger); }
    .toast.info    { background: var(--info); }

    /* â”€â”€ LOADING â”€â”€ */
    .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.4); border-top-color: #fff; border-radius: 50%; animation: spin .7s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ MISC â”€â”€ */
    .section-actions { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .section-actions h2 { font-size: 1rem; font-weight: 600; }
    .mono { font-family: monospace; font-size: .8rem; color: var(--muted); }
  </style>
</head>
<body>

<!-- â”€â”€ NAVBAR â”€â”€ -->
<nav>
  <div class="brand">ğŸ›’ E-Commerce Kafka Dashboard</div>
  <div class="service-pills">
    <div class="pill" id="pill-order">    <div class="dot"></div> Orders   </div>
    <div class="pill" id="pill-payment">  <div class="dot"></div> Payments </div>
    <div class="pill" id="pill-inventory"><div class="dot"></div> Inventory</div>
    <div class="pill" id="pill-notif">    <div class="dot"></div> Notify   </div>
  </div>
</nav>

<!-- â”€â”€ MAIN LAYOUT â”€â”€ -->
<div class="layout">

  <!-- â”€â”€ LEFT: MAIN CONTENT â”€â”€ -->
  <main>

    <!-- Stat bar -->
    <div class="stats">
      <div class="stat-card"><div class="num" id="stat-orders">â€”</div><div class="lbl">Total Orders</div></div>
      <div class="stat-card"><div class="num" id="stat-payments-ok">â€”</div><div class="lbl">Payments OK</div></div>
      <div class="stat-card"><div class="num" id="stat-payments-fail">â€”</div><div class="lbl">Payments Failed</div></div>
      <div class="stat-card"><div class="num" id="stat-inventory">â€”</div><div class="lbl">Products in Stock</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="order">ğŸ“¦ Place Order</button>
      <button class="tab-btn"        data-tab="payments">ğŸ’³ Payments</button>
      <button class="tab-btn"        data-tab="inventory">ğŸª Inventory</button>
      <button class="tab-btn"        data-tab="orders">ğŸ“‹ Order History</button>
    </div>

    <!-- â”€â”€ TAB: PLACE ORDER â”€â”€ -->
    <div class="tab-panel active" id="tab-order">
      <div class="card">
        <h2>Create New Order</h2>
        <form id="order-form">
          <div class="form-grid">
            <div class="form-group">
              <label>User ID</label>
              <input id="f-userId" type="text" placeholder="e.g. user-123" value="user-001" required />
            </div>
            <div class="form-group">
              <label>Product</label>
              <select id="f-productId" required>
                <option value="">â€” select product â€”</option>
                <option value="PROD-001">PROD-001 Â· Laptop Pro 15"</option>
                <option value="PROD-002">PROD-002 Â· Wireless Headphones</option>
                <option value="PROD-003">PROD-003 Â· Mechanical Keyboard</option>
                <option value="PROD-004">PROD-004 Â· USB-C Hub</option>
                <option value="PROD-005">PROD-005 Â· 4K Monitor 27"</option>
              </select>
            </div>
            <div class="form-group">
              <label>Quantity</label>
              <input id="f-quantity" type="number" min="1" max="100" value="1" required />
            </div>
            <div class="form-group">
              <label>Price (per unit $)</label>
              <input id="f-price" type="number" min="0.01" step="0.01" value="299.99" required />
            </div>
            <div class="form-group full">
              <button class="btn btn-primary" type="submit" id="order-btn">
                Place Order
              </button>
            </div>
          </div>
        </form>
      </div>

      <div class="card" id="last-order-card" style="display:none">
        <h2>Last Order Result</h2>
        <div id="last-order-detail"></div>
      </div>
    </div>

    <!-- â”€â”€ TAB: PAYMENTS â”€â”€ -->
    <div class="tab-panel" id="tab-payments">
      <div class="card">
        <div class="section-actions">
          <h2>Payment Records</h2>
          <button class="btn btn-secondary btn-sm" onclick="loadPayments()">âŸ³ Refresh</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Payment ID</th>
                <th>Order ID</th>
                <th>User</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Reason</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody id="payments-tbody">
              <tr class="empty-row"><td colspan="7">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ TAB: INVENTORY â”€â”€ -->
    <div class="tab-panel" id="tab-inventory">
      <div class="card">
        <h2>Add / Restock Product</h2>
        <form id="stock-form">
          <div class="form-grid">
            <div class="form-group">
              <label>Product ID</label>
              <input id="s-productId" placeholder="e.g. PROD-001" required />
            </div>
            <div class="form-group">
              <label>Product Name</label>
              <input id="s-productName" placeholder="e.g. Laptop Pro 15&quot;" />
            </div>
            <div class="form-group">
              <label>Quantity to Add</label>
              <input id="s-quantity" type="number" min="1" value="50" required />
            </div>
            <div class="form-group" style="display:flex;align-items:flex-end">
              <button class="btn btn-primary" type="submit">Add Stock</button>
            </div>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="section-actions">
          <h2>Current Inventory</h2>
          <button class="btn btn-secondary btn-sm" onclick="loadInventory()">âŸ³ Refresh</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Product ID</th>
                <th>Name</th>
                <th>Available</th>
                <th>Reserved</th>
                <th>Stock Level</th>
              </tr>
            </thead>
            <tbody id="inventory-tbody">
              <tr class="empty-row"><td colspan="5">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ TAB: ORDER HISTORY â”€â”€ -->
    <div class="tab-panel" id="tab-orders">
      <div class="card">
        <div class="section-actions">
          <h2>All Orders</h2>
          <button class="btn btn-secondary btn-sm" onclick="loadOrders()">âŸ³ Refresh</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>User</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Status</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody id="orders-tbody">
              <tr class="empty-row"><td colspan="7">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </main>

  <!-- â”€â”€ RIGHT: ACTIVITY FEED â”€â”€ -->
  <aside>
    <div class="sidebar-header">
      <h3>Live Activity Feed</h3>
      <div class="refresh-indicator">
        <div class="pulse"></div>
        <span id="last-refresh">â€“</span>
      </div>
    </div>
    <div class="activity-feed" id="activity-feed">
      <div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:.85rem">
        Waiting for eventsâ€¦<br/>Place an order to see activity.
      </div>
    </div>
    <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px">
      <button class="btn btn-secondary btn-sm" style="flex:1" onclick="clearFeed()">Clear Feed</button>
      <button class="btn btn-secondary btn-sm" style="flex:1" onclick="refreshAll()">âŸ³ Refresh All</button>
    </div>
  </aside>

</div>

<!-- â”€â”€ TOAST CONTAINER â”€â”€ -->
<div id="toast-container"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = {
  orders:    'http://localhost:8081',
  payments:  'http://localhost:8082',
  inventory: 'http://localhost:8083',
  notify:    'http://localhost:8084',
};
const POLL_INTERVAL = 5000;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let prevPayments  = [];
let prevOrders    = [];
let prevInventory = [];
let activityLog   = [];

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  });
});

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'info') {
  const icons = { success: 'âœ“', error: 'âœ—', info: 'â„¹' };
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${icons[type]}</span><span>${msg}</span>`;
  document.getElementById('toast-container').prepend(el);
  setTimeout(() => el.remove(), 4000);
}

// â”€â”€ ACTIVITY FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addActivity(icon, iconClass, title, detail) {
  const now = new Date().toLocaleTimeString();
  activityLog.unshift({ icon, iconClass, title, detail, time: now });
  if (activityLog.length > 50) activityLog.pop();
  renderFeed();
}

function renderFeed() {
  const feed = document.getElementById('activity-feed');
  if (activityLog.length === 0) {
    feed.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:.85rem">No activity yet</div>';
    return;
  }
  feed.innerHTML = activityLog.map(e => `
    <div class="activity-item">
      <div class="activity-icon ${e.iconClass}">${e.icon}</div>
      <div class="activity-body">
        <div class="title">${e.title}</div>
        <div class="detail">${e.detail}</div>
        <div class="time">${e.time}</div>
      </div>
    </div>`).join('');
}

function clearFeed() { activityLog = []; renderFeed(); }

// â”€â”€ SERVICE HEALTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkHealth(url, pillId) {
  const pill = document.getElementById(pillId);
  try {
    const r = await fetch(url, { signal: AbortSignal.timeout(2000) });
    pill.className = r.ok ? 'pill up' : 'pill down';
  } catch {
    pill.className = 'pill down';
  }
}

async function checkAllHealth() {
  checkHealth(API.orders    + '/orders',    'pill-order');
  checkHealth(API.payments  + '/payments',  'pill-payment');
  checkHealth(API.inventory + '/inventory', 'pill-inventory');
  // Notification has no REST API, just check port
  fetch(API.notify + '/actuator/health', { signal: AbortSignal.timeout(2000) })
    .then(r => { document.getElementById('pill-notif').className = r.ok ? 'pill up' : 'pill down'; })
    .catch(() => { document.getElementById('pill-notif').className = 'pill down'; });
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statusBadge(status) {
  const map = {
    'CREATED':    ['badge-info',    'ğŸ“‹ Created'],
    'SUCCESS':    ['badge-success', 'âœ“ Success'],
    'FAILED':     ['badge-danger',  'âœ— Failed'],
    'PROCESSING': ['badge-warning', 'âŸ³ Processing'],
    'RESERVED':   ['badge-success', 'âœ“ Reserved'],
  };
  const [cls, label] = map[status] || ['badge-gray', status];
  return `<span class="badge ${cls}">${label}</span>`;
}

function fmtTime(iso) {
  if (!iso) return 'â€”';
  return new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function shortId(id) {
  if (!id) return 'â€”';
  return `<span class="mono" title="${id}">${id.substring(0, 8)}â€¦</span>`;
}

// â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders() {
  try {
    const res = await fetch(API.orders + '/orders');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    // detect new orders
    const newIds = new Set(data.map(o => o.orderId));
    const prevIds = new Set(prevOrders.map(o => o.orderId));
    data.forEach(o => {
      if (!prevIds.has(o.orderId)) {
        addActivity('ğŸ“¦', 'order', `New order placed`, `${o.productId} Ã— ${o.quantity} Â· $${o.price.toFixed(2)}`);
      }
    });
    prevOrders = data;

    // stats
    document.getElementById('stat-orders').textContent = data.length;

    const tbody = document.getElementById('orders-tbody');
    if (data.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="7">No orders yet. Place your first order!</td></tr>';
      return;
    }
    tbody.innerHTML = [...data].reverse().map(o => `
      <tr>
        <td>${shortId(o.orderId)}</td>
        <td>${o.userId}</td>
        <td>${o.productId}</td>
        <td>${o.quantity}</td>
        <td>$${o.price.toFixed(2)}</td>
        <td>${statusBadge(o.status)}</td>
        <td>${fmtTime(o.createdAt)}</td>
      </tr>`).join('');
  } catch (e) {
    document.getElementById('orders-tbody').innerHTML =
      '<tr class="empty-row"><td colspan="7">âš  Cannot reach order-service (port 8081)</td></tr>';
  }
}

// â”€â”€ PAYMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPayments() {
  try {
    const res = await fetch(API.payments + '/payments');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    // detect new payments
    const prevIds = new Set(prevPayments.map(p => p.paymentId));
    data.forEach(p => {
      if (!prevIds.has(p.paymentId)) {
        const icon   = p.status === 'SUCCESS' ? 'âœ“' : 'âœ—';
        const cls    = p.status === 'SUCCESS' ? 'payment' : 'fail';
        const detail = p.status === 'SUCCESS'
          ? `$${p.amount.toFixed(2)} Â· orderId ${p.orderId.substring(0,8)}â€¦`
          : `$${p.amount.toFixed(2)} Â· ${p.failureReason || 'unknown reason'}`;
        addActivity(icon, cls, `Payment ${p.status === 'SUCCESS' ? 'successful' : 'failed'}`, detail);
      }
    });
    prevPayments = data;

    // stats
    document.getElementById('stat-payments-ok').textContent   = data.filter(p => p.status === 'SUCCESS').length;
    document.getElementById('stat-payments-fail').textContent = data.filter(p => p.status === 'FAILED').length;

    const tbody = document.getElementById('payments-tbody');
    if (data.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="7">No payments yet. Place an order to trigger payment processing.</td></tr>';
      return;
    }
    tbody.innerHTML = [...data].reverse().map(p => `
      <tr>
        <td>${shortId(p.paymentId)}</td>
        <td>${shortId(p.orderId)}</td>
        <td>${p.userId}</td>
        <td>$${p.amount.toFixed(2)}</td>
        <td>${statusBadge(p.status)}</td>
        <td style="max-width:160px;word-break:break-word;font-size:.78rem;color:var(--muted)">${p.failureReason || 'â€”'}</td>
        <td>${fmtTime(p.createdAt)}</td>
      </tr>`).join('');
  } catch (e) {
    document.getElementById('payments-tbody').innerHTML =
      '<tr class="empty-row"><td colspan="7">âš  Cannot reach payment-service (port 8082)</td></tr>';
  }
}

// â”€â”€ INVENTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInventory() {
  try {
    const res = await fetch(API.inventory + '/inventory');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    // detect reservations
    data.forEach(item => {
      const prev = prevInventory.find(p => p.productId === item.productId);
      if (prev && prev.reservedQuantity !== item.reservedQuantity) {
        const delta = item.reservedQuantity - prev.reservedQuantity;
        if (delta > 0) {
          addActivity('ğŸ“¦', 'inventory', `Stock reserved`, `${item.productId}: ${delta} units reserved`);
        }
      }
    });
    prevInventory = data;

    // stats
    document.getElementById('stat-inventory').textContent = data.filter(i => i.availableQuantity > 0).length;

    // populate product dropdown
    const sel = document.getElementById('f-productId');
    const current = sel.value;
    sel.innerHTML = '<option value="">â€” select product â€”</option>';
    data.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.productId;
      opt.textContent = `${item.productId} Â· ${item.productName} (stock: ${item.availableQuantity})`;
      if (item.availableQuantity === 0) opt.textContent += ' âš  out of stock';
      sel.appendChild(opt);
    });
    if (current) sel.value = current;

    const tbody = document.getElementById('inventory-tbody');
    if (data.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="5">No inventory data. Add stock using the form above.</td></tr>';
      return;
    }
    tbody.innerHTML = data.map(item => {
      const total = item.availableQuantity + item.reservedQuantity;
      const pct   = total === 0 ? 0 : Math.round((item.availableQuantity / total) * 100);
      const lvlCls = pct > 50 ? '' : pct > 20 ? 'low' : 'empty';
      return `
        <tr>
          <td><span class="mono">${item.productId}</span></td>
          <td>${item.productName || 'â€”'}</td>
          <td><strong>${item.availableQuantity}</strong></td>
          <td>${item.reservedQuantity}</td>
          <td style="min-width:120px">
            <div style="font-size:.72rem;color:var(--muted)">${pct}% available</div>
            <div class="stock-bar"><div class="stock-bar-fill ${lvlCls}" style="width:${pct}%"></div></div>
          </td>
        </tr>`;
    }).join('');
  } catch (e) {
    document.getElementById('inventory-tbody').innerHTML =
      '<tr class="empty-row"><td colspan="5">âš  Cannot reach inventory-service (port 8083)</td></tr>';
  }
}

// â”€â”€ PLACE ORDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('order-form').addEventListener('submit', async e => {
  e.preventDefault();
  const btn = document.getElementById('order-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Placingâ€¦';

  const body = {
    userId:    document.getElementById('f-userId').value.trim(),
    productId: document.getElementById('f-productId').value,
    quantity:  parseInt(document.getElementById('f-quantity').value),
    price:     parseFloat(document.getElementById('f-price').value),
  };

  try {
    const res = await fetch(API.orders + '/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!res.ok) { const t = await res.text(); throw new Error(t || 'HTTP ' + res.status); }
    const order = await res.json();

    toast('Order placed! Kafka events are flowingâ€¦', 'success');

    const card = document.getElementById('last-order-card');
    const detail = document.getElementById('last-order-detail');
    card.style.display = 'block';
    detail.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:.87rem">
        <div><span style="color:var(--muted)">Order ID</span><br/><span class="mono">${order.orderId}</span></div>
        <div><span style="color:var(--muted)">Status</span><br/>${statusBadge(order.status)}</div>
        <div><span style="color:var(--muted)">Product</span><br/>${order.productId}</div>
        <div><span style="color:var(--muted)">Qty Ã— Price</span><br/>${order.quantity} Ã— $${order.price.toFixed(2)}</div>
        <div style="grid-column:1/-1;margin-top:8px;padding:10px;background:#f8faff;border-radius:8px;font-size:.8rem;color:var(--muted)">
          â„¹ Kafka event published to <code>order.created</code>.
          Payment &amp; Inventory services are processing in the background.
          Switch to <b>Payments</b> or <b>Inventory</b> tabs to see results.
        </div>
      </div>`;

    // auto-refresh after a short delay to pick up downstream events
    setTimeout(refreshAll, 1500);
    setTimeout(refreshAll, 4000);
  } catch (err) {
    toast('Error: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Place Order';
  }
});

// â”€â”€ ADD STOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('stock-form').addEventListener('submit', async e => {
  e.preventDefault();
  const body = {
    productId:   document.getElementById('s-productId').value.trim(),
    productName: document.getElementById('s-productName').value.trim(),
    quantity:    parseInt(document.getElementById('s-quantity').value),
  };
  try {
    const res = await fetch(API.inventory + '/inventory', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const item = await res.json();
    toast(`Stock added: ${item.productId} now has ${item.availableQuantity} units`, 'success');
    addActivity('â•', 'inventory', 'Stock added', `${body.productId}: +${body.quantity} units`);
    loadInventory();
  } catch (err) {
    toast('Error: ' + err.message, 'error');
  }
});

// â”€â”€ REFRESH ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
  await Promise.allSettled([loadOrders(), loadPayments(), loadInventory()]);
  document.getElementById('last-refresh').textContent =
    new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  await checkAllHealth();
  await refreshAll();
  setInterval(refreshAll,    POLL_INTERVAL);
  setInterval(checkAllHealth, 10000);
})();
</script>

</body>
</html>
